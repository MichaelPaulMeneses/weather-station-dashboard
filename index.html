
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Dashboard</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin: 20px 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: fadeIn 1s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .location-bar {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .location-button {
            padding: 12px 28px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .location-button.active {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            transform: scale(1.05);
        }

        .location-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .connection-status.connected {
            background: rgba(76, 175, 80, 0.3);
            color: #fff;
        }

        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.3);
            color: #fff;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-dot.connected {
            background-color: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }

        .status-dot.disconnected {
            background-color: #f44336;
            box-shadow: 0 0 10px #f44336;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 400px 400px 1fr;
            gap: 25px;
            align-items: start;
        }

        .map-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .map-container h2 {
            color: #555;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
        }

        .metro-map {
            width: 100%;
            height: auto;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .station-marker {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .station-marker:hover {
            transform: scale(1.2);
            filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.6));
        }

        .station-marker:active {
            transform: scale(1.1);
        }

        .location-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            font-size: 0.9em;
            color: #555;
        }

        .info-item i {
            color: #667eea;
            font-size: 1.2em;
        }

        .sensors-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-column {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .sensor-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .sensor-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transform: rotate(45deg);
            transition: 0.5s;
        }

        .sensor-card:hover::before {
            left: 100%;
        }

        .sensor-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .sensor-card h2 {
            margin-bottom: 20px;
            font-size: 1.3em;
            color: #555;
            position: relative;
        }

        .sensor-value {
            font-size: 3em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
        }

        .sensor-value.timeout {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .icon {
            font-size: 3em;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .chart-container h2 {
            color: #555;
            margin-bottom: 20px;
            text-align: center;
        }

        .log-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-height: 300px;
            overflow-y: auto;
        }

        .log-container h2 {
            color: #555;
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.95);
            padding-bottom: 10px;
        }

        .log-entry {
            margin: 10px 0;
            padding: 10px;
            font-size: 0.9em;
            color: #666;
            border-left: 3px solid #667eea;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 5px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .subtitle {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            margin-top: -10px;
            margin-bottom: 30px;
            font-size: 1.2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .map-container {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .sensors-column {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            
            .sensors-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå§Ô∏è Weather Station Dashboard</h1>
        <p class="subtitle">Real-time Environmental Monitoring System</p>

        <div class="location-bar">
            <button id="location1" class="location-button active" onclick="switchLocation('location1')">Office Workers</button>
            <button id="location2" class="location-button" onclick="switchLocation('location2')">Government Office</button>
            <button id="location3" class="location-button" onclick="switchLocation('location3')">Students</button>
            <button id="location4" class="location-button" onclick="switchLocation('location4')">Medical</button>
            <button id="location5" class="location-button" onclick="switchLocation('location5')">Laborers</button>
            <button id="location6" class="location-button" onclick="switchLocation('location6')">Farmers</button>
            <div id="connectionStatus" class="connection-status disconnected">
                <div class="status-dot disconnected"></div>
                <span>Disconnected</span>
            </div>
        </div>

        <div class="main-grid">
            <div class="map-container">
                <h2>üìç Metro Manila Monitoring Stations</h2>
                <svg viewBox="0 0 400 500" class="metro-map">
                    <rect width="400" height="500" fill="#e3f2fd"/>
                    <path d="M 0 200 Q 50 180, 80 200 L 80 350 Q 60 370, 0 380 Z" fill="#90caf9" opacity="0.5"/>
                    <path d="M 80 250 Q 150 240, 220 250 Q 280 260, 350 240" stroke="#64b5f6" stroke-width="8" fill="none" opacity="0.6"/>
                    
                    <g id="cities" opacity="0.3">
                        <rect x="80" y="220" width="60" height="60" fill="#1976d2" rx="5"/>
                        <rect x="140" y="140" width="80" height="80" fill="#1976d2" rx="5"/>
                        <rect x="160" y="260" width="50" height="50" fill="#1976d2" rx="5"/>
                        <rect x="220" y="220" width="60" height="60" fill="#1976d2" rx="5"/>
                        <rect x="180" y="220" width="40" height="40" fill="#1976d2" rx="5"/>
                        <rect x="200" y="310" width="60" height="60" fill="#1976d2" rx="5"/>
                        <rect x="100" y="80" width="60" height="60" fill="#1976d2" rx="5"/>
                        <rect x="120" y="340" width="50" height="50" fill="#1976d2" rx="5"/>
                        <rect x="100" y="390" width="50" height="50" fill="#1976d2" rx="5"/>
                        <rect x="160" y="400" width="50" height="60" fill="#1976d2" rx="5"/>
                    </g>
                    
                    <g id="station1" class="station-marker" transform="translate(150, 250)" onclick="switchLocation('location1')">
                        <circle cx="0" cy="0" r="20" fill="#4caf50" opacity="0.3" class="pulse-ring">
                            <animate attributeName="r" values="20;25;20" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="0" cy="0" r="12" fill="#4caf50" stroke="white" stroke-width="3" class="station-dot"/>
                        <text x="0" y="5" text-anchor="middle" fill="white" font-size="14" font-weight="bold">1</text>
                    </g>
                    
                    <g id="station2" class="station-marker" transform="translate(220, 180)" onclick="switchLocation('location2')">
                        <circle cx="0" cy="0" r="20" fill="#9e9e9e" opacity="0.3" class="pulse-ring">
                            <animate attributeName="r" values="20;25;20" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="0" cy="0" r="12" fill="#9e9e9e" stroke="white" stroke-width="3" class="station-dot"/>
                        <text x="0" y="5" text-anchor="middle" fill="white" font-size="14" font-weight="bold">2</text>
                    </g>
                    
                    <g id="station3" class="station-marker" transform="translate(180, 160)" onclick="switchLocation('location3')">
                        <circle cx="0" cy="0" r="20" fill="#9e9e9e" opacity="0.3" class="pulse-ring">
                            <animate attributeName="r" values="20;25;20" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="0" cy="0" r="12" fill="#9e9e9e" stroke="white" stroke-width="3" class="station-dot"/>
                        <text x="0" y="5" text-anchor="middle" fill="white" font-size="14" font-weight="bold">3</text>
                    </g>
                    
                    <g id="station4" class="station-marker" transform="translate(190, 280)" onclick="switchLocation('location4')">
                        <circle cx="0" cy="0" r="20" fill="#9e9e9e" opacity="0.3" class="pulse-ring">
                            <animate attributeName="r" values="20;25;20" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="0" cy="0" r="12" fill="#9e9e9e" stroke="white" stroke-width="3" class="station-dot"/>
                        <text x="0" y="5" text-anchor="middle" fill="white" font-size="14" font-weight="bold">4</text>
                    </g>
                    
                    <g id="station5" class="station-marker" transform="translate(240, 330)" onclick="switchLocation('location5')">
                        <circle cx="0" cy="0" r="20" fill="#9e9e9e" opacity="0.3" class="pulse-ring">
                            <animate attributeName="r" values="20;25;20" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="0" cy="0" r="12" fill="#9e9e9e" stroke="white" stroke-width="3" class="station-dot"/>
                        <text x="0" y="5" text-anchor="middle" fill="white" font-size="14" font-weight="bold">5</text>
                    </g>
                    
                    <g id="station6" class="station-marker" transform="translate(120, 120)" onclick="switchLocation('location6')">
                        <circle cx="0" cy="0" r="20" fill="#9e9e9e" opacity="0.3" class="pulse-ring">
                            <animate attributeName="r" values="20;25;20" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <circle cx="0" cy="0" r="12" fill="#9e9e9e" stroke="white" stroke-width="3" class="station-dot"/>
                        <text x="0" y="5" text-anchor="middle" fill="white" font-size="14" font-weight="bold">6</text>
                    </g>
                    
                    <text x="150" y="290" text-anchor="middle" font-size="11" font-weight="bold" fill="#2e7d32">Office Workers</text>
                    <text x="220" y="170" text-anchor="middle" font-size="11" font-weight="bold" fill="#1565c0">Gov Office</text>
                    <text x="180" y="150" text-anchor="middle" font-size="11" font-weight="bold" fill="#666">Students</text>
                    <text x="190" y="310" text-anchor="middle" font-size="11" font-weight="bold" fill="#666">Medical</text>
                    <text x="240" y="360" text-anchor="middle" font-size="11" font-weight="bold" fill="#666">Laborers</text>
                    <text x="120" y="110" text-anchor="middle" font-size="11" font-weight="bold" fill="#666">Farmers</text>
                    
                    <g transform="translate(20, 450)">
                        <text x="0" y="0" font-size="11" font-weight="bold" fill="#555">Active Station:</text>
                        <circle cx="85" cy="-4" r="6" fill="#4caf50"/>
                        <text x="95" y="0" font-size="10" fill="#666">Online</text>
                    </g>
                    
                    <g transform="translate(360, 40)">
                        <circle cx="0" cy="0" r="25" fill="white" stroke="#667eea" stroke-width="2"/>
                        <text x="0" y="-12" text-anchor="middle" font-size="12" font-weight="bold" fill="#667eea">N</text>
                        <polygon points="0,-18 -3,3 0,0 3,3" fill="#667eea"/>
                    </g>
                </svg>
                
                <div class="location-info">
                    <div class="info-item">
                        <i class="fa-solid fa-location-dot"></i>
                        <span>Real-time monitoring across Metro Manila</span>
                    </div>
                    <div class="info-item">
                        <i class="fa-solid fa-tower-cell"></i>
                        <span id="activeStationInfo">Station 1: Office Workers</span>
                    </div>
                </div>
            </div>

            <div class="sensors-column">
                <div class="sensor-card">
                    <i class="fa-solid fa-thermometer-half icon"></i>
                    <h2>Temperature & Humidity</h2>
                    <div>üå°Ô∏è <span id="temperature" class="sensor-value">--</span>¬∞C</div>
                    <div style="margin-top: 10px;">üíß <span id="humidity" class="sensor-value" style="font-size: 2em;">--</span>%</div>
                </div>
                <div class="sensor-card">
                    <i class="fa-solid fa-wind icon"></i>
                    <h2>Wind Speed</h2>
                    <div><span id="windSpeed" class="sensor-value">--</span></div>
                    <div style="margin-top: 5px; color: #666;">m/s</div>
                </div>
                <div class="sensor-card">
                    <i class="fa-solid fa-compass icon"></i>
                    <h2>Wind Direction</h2>
                    <div><span id="windDirection" class="sensor-value">--</span>¬∞</div>
                    <div id="windDirectionText" style="margin-top: 5px; color: #666; font-weight: 600;">--</div>
                </div>
                <div class="sensor-card">
                    <i class="fa-solid fa-gauge-high icon"></i>
                    <h2>Atmospheric Pressure</h2>
                    <div><span id="pressure" class="sensor-value">--</span></div>
                    <div style="margin-top: 5px; color: #666;">hPa</div>
                </div>
                <div class="sensor-card">
                    <i class="fa-solid fa-cloud-rain icon"></i>
                    <h2>Rainfall</h2>
                    <div><span id="rainfall" class="sensor-value">--</span></div>
                    <div style="margin-top: 5px; color: #666;">mm</div>
                </div>
            </div>

            <div class="info-column">
                <div class="chart-container">
                    <h2>üìà Temperature History</h2>
                    <canvas id="tempChart"></canvas>
                </div>
                <div class="chart-container">
                    <h2>üí® Wind Speed History</h2>
                    <canvas id="windChart"></canvas>
                </div>
                <div class="log-container">
                    <h2>üìã System Log</h2>
                    <div id="log"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configurations - Fixed: Removed duplicate declarations
        const firebaseConfig1 = {
            apiKey: "AIzaSyCC-6pU4yRWZy4RuhPwuDQQ6yWY-FUGrdA",
            databaseURL: "https://final-project-f2e0a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "final-project-f2e0a"
        };

        const firebaseConfig2 = {
            apiKey: "AIzaSyAsI0i6bztLGXxOvEHy5ZWPxmPUrD-vILw",
            databaseURL: "https://governmentoffice-37134-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "philippines-weather-station"
        };

        const firebaseConfig3 = {
            apiKey: "AIzaSyCC-6pU4yRWZy4RuhPwuDQQ6yWY-FUGrdA",
            databaseURL: "https://final-project-f2e0a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "final-project-f2e0a"
        };

        const firebaseConfig4 = {
            apiKey: "AIzaSyCC-6pU4yRWZy4RuhPwuDQQ6yWY-FUGrdA",
            databaseURL: "https://final-project-f2e0a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "final-project-f2e0a"
        };

        const firebaseConfig5 = {
            apiKey: "AIzaSyCC-6pU4yRWZy4RuhPwuDQQ6yWY-FUGrdA",
            databaseURL: "https://final-project-f2e0a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "final-project-f2e0a"
        };

        const firebaseConfig6 = {
            apiKey: "AIzaSyCC-6pU4yRWZy4RuhPwuDQQ6yWY-FUGrdA",
            databaseURL: "https://final-project-f2e0a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "final-project-f2e0a"
        };

        // Location metadata
        const locationNames = {
            'location1': 'Office Workers',
            'location2': 'Government Office',
            'location3': 'Students',
            'location4': 'Medical',
            'location5': 'Laborers',
            'location6': 'Farmers'
        };

        const locationColors = {
            'location1': '#4caf50',
            'location2': '#2196f3',
            'location3': '#ff9800',
            'location4': '#e91e63',
            'location5': '#9c27b0',
            'location6': '#795548'
        };

        let activeLocation = 'location1';
        let currentApp = null;
        let databaseListeners = [];
        let connectionRef = null;
        let sensorTimeouts = {};

        const maxDataPoints = 20;
        let tempData = [];
        let windData = [];
        let timeLabels = [];

        const TIMEOUT_DURATION = 60000;

        // Initialize charts
        const tempChart = new Chart(document.getElementById('tempChart'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Temperature (¬∞C)',
                    data: tempData,
                    borderColor: 'rgb(102, 126, 234)',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });

        const windChart = new Chart(document.getElementById('windChart'), {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Wind Speed (m/s)',
                    data: windData,
                    borderColor: 'rgb(118, 75, 162)',
                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        function updateChart(chart, dataArray, newValue) {
            const time = new Date().toLocaleTimeString();
            
            if (dataArray.length >= maxDataPoints) {
                dataArray.shift();
                if (timeLabels.length >= maxDataPoints) {
                    timeLabels.shift();
                }
            }
            
            dataArray.push(newValue);
            if (timeLabels.length < maxDataPoints || dataArray === tempData) {
                timeLabels.push(time);
            }
            
            chart.update();
        }

        function getWindDirection(degrees) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(degrees / 45) % 8;
            return directions[index];
        }

        function updateSensorValue(elementId, value, timeoutDuration = TIMEOUT_DURATION) {
            const element = document.getElementById(elementId);
            element.textContent = value;
            element.classList.remove('timeout');

            if (elementId === 'temperature') {
                updateChart(tempChart, tempData, parseFloat(value));
            } else if (elementId === 'windSpeed') {
                updateChart(windChart, windData, parseFloat(value));
            } else if (elementId === 'windDirection') {
                const dirText = getWindDirection(parseFloat(value));
                document.getElementById('windDirectionText').textContent = dirText;
            }

            if (sensorTimeouts[elementId]) {
                clearTimeout(sensorTimeouts[elementId]);
            }

            sensorTimeouts[elementId] = setTimeout(() => {
                element.textContent = '--';
                element.classList.add('timeout');
                debugLog(`${elementId} timeout - no data`);
            }, timeoutDuration);
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const dotElement = statusElement.querySelector('.status-dot');
            const textElement = statusElement.querySelector('span');

            if (connected) {
                statusElement.className = 'connection-status connected';
                dotElement.className = 'status-dot connected';
                textElement.textContent = 'Connected';
                debugLog('‚úÖ Firebase connected');
            } else {
                statusElement.className = 'connection-status disconnected';
                dotElement.className = 'status-dot disconnected';
                textElement.textContent = 'Disconnected';
                debugLog('‚ùå Firebase disconnected');
                clearAllTimeouts();
            }
        }

        function clearAllTimeouts() {
            Object.keys(sensorTimeouts).forEach(key => {
                if (sensorTimeouts[key]) {
                    clearTimeout(sensorTimeouts[key]);
                }
            });
            sensorTimeouts = {};
        }

        function clearSensorValues() {
            const sensors = ['temperature', 'humidity', 'windSpeed', 'windDirection', 'pressure', 'rainfall'];
            sensors.forEach(sensor => {
                const element = document.getElementById(sensor);
                element.textContent = '--';
                element.classList.remove('timeout');
            });
            document.getElementById('windDirectionText').textContent = '--';
            clearAllTimeouts();
        }

        function removeAllListeners() {
            if (connectionRef) {
                connectionRef.off();
                connectionRef = null;
            }
            
            databaseListeners.forEach(listener => {
                if (listener.ref) {
                    listener.ref.off('value', listener.callback);
                }
            });
            databaseListeners = [];
        }

        async function initializeFirebase(config) {
            removeAllListeners();
            clearSensorValues();
            updateConnectionStatus(false);
            
            if (!config || !config.databaseURL) {
                debugLog('‚ö†Ô∏è No configuration for this location');
                return;
            }

            try {
                if (currentApp) {
                    await currentApp.delete();
                    currentApp = null;
                }

                await new Promise(resolve => setTimeout(resolve, 200));

                currentApp = firebase.initializeApp(config, 'weather-' + Date.now());
                const database = currentApp.database();
                
                debugLog('üîÑ Connecting to Firebase...');

                connectionRef = database.ref('.info/connected');
                connectionRef.on('value', (snap) => {
                    updateConnectionStatus(snap.val() === true);
                });

                loadSensorListeners(database);
                
            } catch (error) {
                debugLog(`‚ùå Firebase error: ${error.message}`);
                updateConnectionStatus(false);
            }
        }

        function addDatabaseListener(ref, callback) {
            ref.on('value', callback);
            databaseListeners.push({ ref: ref, callback: callback });
        }

        function loadSensorListeners(database) {
            if (!database) return;

            addDatabaseListener(
                database.ref('DHT22_Sensor_01/temperature'),
                (snapshot) => {
                    const value = snapshot.val();
                    if (value !== null && !isNaN(value)) {
                        updateSensorValue('temperature', value.toFixed(1));
                        debugLog(`üå°Ô∏è Temperature: ${value.toFixed(1)}¬∞C`);
                    }
                }
            );

            addDatabaseListener(
                database.ref('DHT22_Sensor_01/humidity'),
                (snapshot) => {
                    const value = snapshot.val();
                    if (value !== null && !isNaN(value)) {
                        updateSensorValue('humidity', value.toFixed(1));
                        debugLog(`üíß Humidity: ${value.toFixed(1)}%`);
                    }
                }
            );

            addDatabaseListener(
                database.ref('Wind_Sensor_01/wind_speed'),
                (snapshot) => {
                    const value = snapshot.val();
                    if (value !== null && !isNaN(value)) {
                        updateSensorValue('windSpeed', value.toFixed(1));
                        debugLog(`üí® Wind Speed: ${value.toFixed(1)} m/s`);
                    }
                }
            );

            addDatabaseListener(
                database.ref('Wind_Sensor_01/wind_direction'),
                (snapshot) => {
                    const value = snapshot.val();
                    if (value !== null && !isNaN(value)) {
                        updateSensorValue('windDirection', value.toFixed(0));
                        debugLog(`üß≠ Wind Direction: ${value.toFixed(0)}¬∞`);
                    }
                }
            );

            addDatabaseListener(
                database.ref('Pressure_Sensor_01/pressure'),
                (snapshot) => {
                    const value = snapshot.val();
                    if (value !== null && !isNaN(value)) {
                        updateSensorValue('pressure', value.toFixed(1));
                        debugLog(`üìä Pressure: ${value.toFixed(1)} hPa`);
                    }
                }
            );

            addDatabaseListener(
                database.ref('Rain_Gauge_01/rainfall'),
                (snapshot) => {
                    const value = snapshot.val();
                    if (value !== null && !isNaN(value)) {
                        updateSensorValue('rainfall', value.toFixed(1));
                        debugLog(`üåßÔ∏è Rainfall: ${value.toFixed(1)} mm`);
                    }
                }
            );
        }

        function switchLocation(location) {
            if (location === activeLocation) return;

            ['location1', 'location2', 'location3', 'location4', 'location5', 'location6'].forEach(loc => {
                const btn = document.getElementById(loc);
                btn.classList.toggle('active', loc === location);
            });

            activeLocation = location;
            
            const activeStationInfo = document.getElementById('activeStationInfo');
            const locationColor = locationColors[location];
            const locationName = locationNames[location];
            
            for (let i = 1; i <= 6; i++) {
                const station = document.getElementById(`station${i}`);
                if (station) {
                    station.querySelector('.station-dot').setAttribute('fill', '#9e9e9e');
                    station.querySelector('.pulse-ring').setAttribute('fill', '#9e9e9e');
                }
            }
            
            const stationNum = location.replace('location', '');
            const activeStation = document.getElementById(`station${stationNum}`);
            if (activeStation) {
                activeStation.querySelector('.station-dot').setAttribute('fill', locationColor);
                activeStation.querySelector('.pulse-ring').setAttribute('fill', locationColor);
            }
            
            activeStationInfo.innerHTML = `<i class="fa-solid fa-circle" style="color: ${locationColor}; font-size: 0.8em;"></i> Station ${stationNum}: ${locationName}`;
            
            tempData = [];
            windData = [];
            timeLabels = [];
            tempChart.update();
            windChart.update();
            
            const configs = {
                'location1': firebaseConfig1,
                'location2': firebaseConfig2,
                'location3': firebaseConfig3,
                'location4': firebaseConfig4,
                'location5': firebaseConfig5,
                'location6': firebaseConfig6
            };
            
            initializeFirebase(configs[location]);
            debugLog(`üîÑ Switched to ${locationName}`);
        }

        function debugLog(message) {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
            
            while (logDiv.children.length > 50) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        window.addEventListener('load', () => {
            debugLog('üöÄ Dashboard initialized');
            initializeFirebase(firebaseConfig1);
        });
    </script>
</body>
</html>